<%inherit file="base.html"/>
<%!
        import pathlib
        import mylar
%>

<%def name="headIncludes()">
</%def>

<%def name="body()">
        <div id="paddingheader">
                <h1 class="clearfix">Maintenance Options</h1></br>
        </div>
        <div id="tabs">
                <ul>
                        <li><a href="#tabs-1">Update base Directory</a></li>
                        <li><a href="#tabs-2">1</a></li>
                        <li><a href="#tabs-2">2</a></li>
                </ul>
                <div id="tabs-1" class="configtable">
                              <div style="float:right;position:absolute;right:0;top:10;margin-right:50px;">
                                   <legend>Folder Structure</legend>
                                   <%
                                       format_len = len(folderformat)
                                   %>
                                   <input type="text" id="folderformat" name="folderformat" value="${folderformat}" size="${format_len}" DISABLED/></br></br>
                                   <fieldset>
                                       <div>
                                            <%
                                                 cpath = pathlib.PurePath(original_location)
                                                 currentpath = cpath.joinpath("series")
                                            %>
                                            <div id="cpathformat">
                                                <legend>Current Directory Structure:</legend>
                                                <span id="cwarning"></span>
                                                <span id="cpath">${original_location}</span></br>
                                            </div>
                                       </div>
                                   </fieldset>
                                   <fieldset>
                                            <%
                                                 if newcomdir is not None:
                                                     npath = pathlib.PurePath(newcomdir)
                                                     newpath = npath.joinpath("series")
                                                     if len(newpath) > 70:
                                                         newpath = newpath[:70] + "</br>" + newpath[71:]
                                                 else:
                                                     newpath = None
                                            %>
                                            <div id="newpathformat">
                                                <legend>Proposed Directory Structure:</legend>
                                                <span id="newpath">${newpath}</span></br>
                                            </div>
                                   <input type="hidden" name="comicid" id="comicid" value="${comicid}" />
                                   </fieldset>
                               </div>
                           <form action="" method="GET" id="updateBase">
                                   <fieldset>
                                        <legend>Update Base Directory</legend>
                                        <p>Do this when you're moving your comics to a different location,</p> 
                                        <p>and want to update the paths within the db so Mylar can still</p>
                                        <p> monitor them.</p>
                                        <br/>
                                        <p><b>This will only update the paths in the db. IT WILL NOT MOVE ANYTHING.</b></p>
                                        <p style="font-size:10px;">If moving between different OS' you NEED to perform this on the NEW OS to
                                        ensure proper conversion.
                                        </br>Note that the Original Location value might be different than the current directory stucture</p>
                                        <br/>
                                        <div class="row">
                                           <label>Original Location:</label><input type="text" value="${original_location}" name="original_location" size="70" disabled/>
                                        </div>
                                        <div class="row">
                                            <label>New Location:</label>
                                               <input type="text" value="Enter the new Directory Location" onfocus="if
                                               (this.value==this.defaultValue) this.value='';" name="newcomdir" id="newcomdir" size="70" />
                                        </div>
                                        <div class="row checkbox">
                                           <input type="checkbox" title="Format the new paths as per the Folder Format setting" onclick="chkformat()" name="fftonewcom" id="fftonewcom" value="1" ${fftonewcom} /><label>Enforce Folder Format when updating?</label>
                                        </div>
                                        <div class="col-xs-12">
                                            <input type="button" class="btn btn-primary pull-right" style="position:absolute;float:right;" id="formatenable" value="Show Folder Structure" onclick="changeTest()">
                                        </div>
                                        <input type="button" value="Update!" style="postion:absolute;float:right;" onclick="updatedB(single=true)"/>
                                        <input type="button" value="Update All!" style="postion:absolute;float:right;" onclick="updatedB(single=false)"/>
                                   </fieldset>
                        </form>
                    </td>
                  </tr>
                  <div id="actions">
                      <input type="hidden" name="notheshow" id="notheshow" checked />
                      <small><a href="#" id="helpout"><span class="ui-button-icon-primary ui-icon ui-icon-help"></span>Help.</a></small>
                      %if not [False for x in mylar.NOSHOW if 'updatedb' in x] or notheshow == "true":
                         <div id="dialog" title="Instructions on how to update the DB to point to a new location.">
                          <h1>${orig_os} ---> ${dest_os}</h1></br>
                          <b>In order for the update to work properly, the update/conversion HAS to take place on the system where the new version of Mylar will reside.</b></br>
                          </br>Follow these steps (at least as a guideline): </br>
                          <p>1. The mylar.db has been moved to the new system and you are now running it and seeing this dialog</br>
                             2. <b>Disable</b> <i>RSS Searches, Automated Searches, DB Updates</i> via the <i>Manage tab / Advanced / Schedulers</i></br>
                             3. Ensure that the Original Location is <b>STILL</b> pointing to the old location - if not revert it back via the configuration</br>
                             4. Enter the new Comic Location path in the New Location field.</br>
                             5. If you want to change your folder structure (ie. change to <i>$Publisher/$Series...</i> from just <i>$Series...</i>), enable the Enforce Folder Format option</br>
                             6. If your structure is already setup(ie. you already have it under <i>$Publisher/$Series</i>, or are ok with just <i>$Series...</i>), leave the option unchecked.</br>
                             7. Click on Show Folder Structure to see an random example of what your current and new paths will look like.</br>
                             8. If you have Enforce Folder Format enabled, you can also modify the folder format to your liking at this point if required</br>
                             9. Click on Update! to update the specific example as per the settings enabled (ie. as a test subject)</br>
                             10. Click on Update All! to update all the items in the db with the given information</br>
                             11. Mylar will restart after the changes to ensure the paths are all correct.</br>
                            </br><center>Note that Mylar will also update your ComicLocation path in the Configuration page to the New Location path upon a successful Update All! onption</center></br></p>
                          <input type="checkbox" title="Do not show popup instructions again" name="update_noshow" id="update_noshow" value="1" ${update_noshow} /><label> Do not show again</label>
                         </div>
                      %endif
                  </div>
                </div>
        </div>
</%def>

<%def name="javascriptIncludes()">
        <script src="js/libs/jquery.dataTables.min.js"></script>
        <script>
        var original_format;
        function openHelp() {
            var notshow = document.getElementById("update_noshow");
            var nono = document.getElementById("notheshow");
            if (notshow.checked == true){
                nono.removeAttribute("disabled");
            }
            $("#dialog").dialog();
        };
        function chkformat(){
            var foldf = document.getElementById("folderformat");
            var eff = document.getElementById("fftonewcom");
            if (eff.checked == true){
                foldf.removeAttribute("disabled");
            } else {
                foldf.setAttribute("disabled", "disabled");
                foldf.value = original_format;
            }
        }
        function changeTest(){
            var formatopt = document.getElementById("fftonewcom").checked;
            var newdir = document.getElementById("newcomdir").value;
            var foldformat = document.getElementById("folderformat").value;
            if (newdir == "Enter the new Directory Location"){
                alert("You need to specify a New Directory Location first!");
                return;
            }
            $.get("maintain",
                { temppath: newdir, tempff: formatopt, folderformat: foldformat, update: false },
                function(data){
                    if (data.error != undefined) {
                        alert(data.error);
                        return;
                    }
                    var objlevel = JSON.parse(data);
                    var status = objlevel["status"];
                    if (status == 'warning'){
                        document.getElementById("cwarning").innerHTML = "Warning: Original path location not the same as dB series location.</br>";
                    }
                    var obj = objlevel["data"];
                    st = obj["original_location"].lastIndexOf("/");
                    if (st == -1){
					    st = obj["original_location"].lastIndexOf("\\");
					}
                    origlines = obj["original_location"].slice(0, st+1) + '</br><p style="text-indent:10px">' + obj["original_location"].slice(st+1) + "</p>";
                    stt = obj["comlocation"].lastIndexOf("/");
					if (stt == -1){
					    stt = obj["comlocation"].lastIndexOf("\\");
					}
                    newlines = obj["comlocation"].slice(0, stt+1) + '</br><p style="text-indent:10px">' + obj["comlocation"].slice(stt+1) + "</p>";
                    document.getElementById("cpathformat").style.display = "block";
                    document.getElementById("cpath").innerHTML = origlines;
                    document.getElementById("newpathformat").style.display = "block";
                    document.getElementById("newpath").innerHTML = newlines;
                    document.getElementById("comicid").value = obj["comicid"];
            });
        }
        function updatedB(single){
            var result = document.getElementById("dialog");
            var formatopt = document.getElementById("fftonewcom").checked;
            var newdir = document.getElementById("newcomdir").value;
            var foldformat = document.getElementById("folderformat").value;
            if (newdir == "Enter the new Directory Location"){
                alert("You need to specify a New Directory Location first!");
                return;
            }
            var comicid;
            if (single == true){
                var comicid = document.getElementById("comicid").value;
            }
            $.get("maintain",
                { temppath: newdir, tempff: formatopt, folderformat: foldformat, update: true, comicid: comicid },
                function(data){
                    if (data.error != undefined) {
                        alert(data.error);
                        return;
                    }
                    var objlevel = JSON.parse(data);
                    var status = objlevel["status"];
                    if (status == 'warning'){
                        var obj = objlevel["data"];
                        var comicid;
                        var comlocation;
                        var origlocation;
                        for (var key in obj) {
                            for (var prop in obj[key]){
                                if (obj[key] == "comicid"){
                                    comicid = obj[key][prop];
                                } else if (obj[key] == "comlocation"){
                                    comlocation = obj[key][prop];
                                } else {
                                    origlocation = obj[key][prop];
                                }
                                dialog.innerHTML += "["+comicid+"] "+comlocation+"-->"+origlocation+"</br>";
                            }
                        }
                        $("#dialog").dialog({
                            modal: true,
                            width: "50%",
                            maxHeight: 500
                        });
                    }   
            });
        }
        function initThisPage(){
                $(function(){
                        $( "#tabs" ).tabs();
                });
                $("#helpout").click(openHelp);
                $('div#dialog').on('dialogclose', function(event) {
                    var noshow = document.getElementById("update_noshow");
                    var pagedes = String('updatedb');
                    if (noshow.checked == true){
                        $.get("noshow_check",
                            { checked: noshow.checked, pagedes: pagedes },
                            function(data){
                                if (data.error != undefined) {
                                    alert(data.error);
                                    return;
                                }
                        });
                    }
                });
        }
        $(document).ready(function() {
                original_format = document.getElementById("folderformat").value;
                document.getElementById("newpathformat").style.display = "none";
                initThisPage();
                $("#dialog").dialog({
                    modal: false,
                    width: "50%",
                    maxHeight: 500
                });
        });

        </script>
</%def>

